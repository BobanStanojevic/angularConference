<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <style>
/*--------------------------------------------------------------------------------------------- * Copyright (c) Microsoft Corporation. All rights reserved. * Licensed under the MIT License. See License.txt in the project root for license information. *--------------------------------------------------------------------------------------------*/ body { font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback"; font-size: 14px; padding: 0 12px; line-height: 22px; word-wrap: break-word; } body.scrollBeyondLastLine { margin-bottom: calc(100vh - 22px); } body.showEditorSelection .code-line { position: relative; } body.showEditorSelection .code-active-line:before, body.showEditorSelection .code-line:hover:before { content: ""; display: block; position: absolute; top: 0; left: -12px; height: 100%; } body.showEditorSelection li.code-active-line:before, body.showEditorSelection li.code-line:hover:before { left: -30px; } .vscode-light.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(0, 0, 0, 0.15); } .vscode-light.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(0, 0, 0, 0.40); } .vscode-dark.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 255, 255, 0.4); } .vscode-dark.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 255, 255, 0.60); } .vscode-high-contrast.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 160, 0, 0.7); } .vscode-high-contrast.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 160, 0, 1); } img { max-width: 100%; max-height: 100%; } a { color: #4080D0; text-decoration: none; } a:focus, input:focus, select:focus, textarea:focus { outline: 1px solid -webkit-focus-ring-color; outline-offset: -1px; } hr { border: 0; height: 2px; border-bottom: 2px solid; } h1 { padding-bottom: 0.3em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; } h1, h2, h3 { font-weight: normal; } h1 code, h2 code, h3 code, h4 code, h5 code, h6 code { font-size: inherit; line-height: auto; } a:hover { color: #4080D0; text-decoration: underline; } table { border-collapse: collapse; } table > thead > tr > th { text-align: left; border-bottom: 1px solid; } table > thead > tr > th, table > thead > tr > td, table > tbody > tr > th, table > tbody > tr > td { padding: 5px 10px; } table > tbody > tr + tr > td { border-top: 1px solid; } blockquote { margin: 0 7px 0 5px; padding: 0 16px 0 10px; border-left: 5px solid; } code { font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback"; font-size: 14px; line-height: 19px; } body.wordWrap pre { white-space: pre-wrap; } .mac code { font-size: 12px; line-height: 18px; } code > div { padding: 16px; border-radius: 3px; overflow: auto; } /** Theming */ .vscode-light { color: rgb(30, 30, 30); } .vscode-dark { color: #DDD; } .vscode-high-contrast { color: white; } .vscode-light code { color: #A31515; } .vscode-dark code { color: #D7BA7D; } .vscode-light code > div { background-color: rgba(220, 220, 220, 0.4); } .vscode-dark code > div { background-color: rgba(10, 10, 10, 0.4); } .vscode-high-contrast code > div { background-color: rgb(0, 0, 0); } .vscode-high-contrast h1 { border-color: rgb(0, 0, 0); } .vscode-light table > thead > tr > th { border-color: rgba(0, 0, 0, 0.69); } .vscode-dark table > thead > tr > th { border-color: rgba(255, 255, 255, 0.69); } .vscode-light h1, .vscode-light hr, .vscode-light table > tbody > tr + tr > td { border-color: rgba(0, 0, 0, 0.18); } .vscode-dark h1, .vscode-dark hr, .vscode-dark table > tbody > tr + tr > td { border-color: rgba(255, 255, 255, 0.18); } .vscode-light blockquote, .vscode-dark blockquote { background: rgba(127, 127, 127, 0.1); border-color: rgba(0, 122, 204, 0.5); } .vscode-high-contrast blockquote { background: transparent; border-color: #fff; }
</style>
<style>
/* Tomorrow Theme */ /* http://jmblog.github.com/color-themes-for-google-code-highlightjs */ /* Original theme - https://github.com/chriskempson/tomorrow-theme */ /* Tomorrow Comment */ .hljs-comment, .hljs-quote { color: #8e908c; } /* Tomorrow Red */ .hljs-variable, .hljs-template-variable, .hljs-tag, .hljs-name, .hljs-selector-id, .hljs-selector-class, .hljs-regexp, .hljs-deletion { color: #c82829; } /* Tomorrow Orange */ .hljs-number, .hljs-built_in, .hljs-builtin-name, .hljs-literal, .hljs-type, .hljs-params, .hljs-meta, .hljs-link { color: #f5871f; } /* Tomorrow Yellow */ .hljs-attribute { color: #eab700; } /* Tomorrow Green */ .hljs-string, .hljs-symbol, .hljs-bullet, .hljs-addition { color: #718c00; } /* Tomorrow Blue */ .hljs-title, .hljs-section { color: #4271ae; } /* Tomorrow Purple */ .hljs-keyword, .hljs-selector-tag { color: #8959a8; } .hljs { display: block; overflow-x: auto; color: #4d4d4c; padding: 0.5em; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; }
</style>
<style>
ul.contains-task-list { padding-left: 0; } ul ul.contains-task-list { padding-left: 40px; } .task-list-item { list-style-type: none; } .task-list-item-checkbox { vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'HelveticaNeue-Light', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
    </head>
    <body>
        <h1 id="advanced-routing">Advanced Routing</h1>
<ul>
<li><a href="#advanced-routing">Advanced Routing</a>
<ul>
<li><a href="#guards">Guards</a>
<ul>
<li><a href="#canactivateguard">CanActivateGuard</a></li>
</ul>
</li>
<li><a href="#bonus-login">Bonus: Login **</a></li>
<li><a href="#candeactivateguard">CanDeactivateGuard</a></li>
<li><a href="#httpinterceptor">HttpInterceptor</a></li>
</ul>
</li>
</ul>
<h2 id="guards">Guards</h2>
<h3 id="canactivateguard">CanActivateGuard</h3>
<p>In this exercise, you will create an <code>AuthService</code> that users can use to log in. This <code>AuthService</code> remembers the current user name and whether the user is logged in. The possibilities of the service should be offered to the user in the <code>HomeComponent</code>.</p>
<p>In addition, create a <code>CanActivate</code>-Guard named <code>AuthGuard</code>, which only allows a route change if the current user is logged in. For this it relies on the <code>AuthService</code>:</p>
<pre><code>  [HomeComponent] -------> [AuthService]
                                 ^
                                 |
                            [AuthGuard]
</code></pre>
<p>You can use the following procedure:</p>
<ol>
<li>
<p>Create a <code>auth</code> folder in the <code>shared</code> folder.</p>
</li>
<li>
<p>Create an <code>AuthService</code> in the new folder <code>auth</code>:</p>
<pre class="hljs"><code><div>@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthService {

    userName: <span class="hljs-built_in">string</span>;

    <span class="hljs-keyword">constructor</span>() { }
    
    login() {
        <span class="hljs-keyword">this</span>.userName = <span class="hljs-string">'Max'</span>;
    }

    logout() {
        <span class="hljs-keyword">this</span>.userName = <span class="hljs-literal">null</span>;
    }

}
</div></code></pre>
</li>
<li>
<p>Create a <code>auth.guard.ts</code> file in the same folder with a <code>CanActivate</code> guard based on <code>AuthService</code>.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthGuard <span class="hljs-keyword">implements</span> CanActivate {

    <span class="hljs-keyword">constructor</span>(private router: Router, private authService: AuthService) { }

    canActivate() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.authService.userName) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">this</span>.router.navigate([<span class="hljs-string">'/home'</span>, { needsLogin: <span class="hljs-literal">true</span> }])
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

}
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Register the <code>AuthGuard</code> and <code>AuthService</code> in the file ``</p>
</li>
<li>
<p>shared.module.ts``.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>@NgModule({
  [...]
  providers: [
    AuthService,
    AuthGuard
  ],
  [...]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> SharedModule { }
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Make sure the <code>AppModule</code> (<code>app.module.ts</code>) imports <code>SharedModule</code>.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>@NgModule({
  imports: [
     [...]
    SharedModule
  ],
  [...]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule { }
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Open the file <code>home.component.ts</code> and have the <code>AuthService</code> injected there. Wrap its functionality with methods or setters.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HomeComponent <span class="hljs-keyword">implements</span> OnInit {

  <span class="hljs-keyword">constructor</span>(private authService: AuthService) { }

  ngOnInit() {
  }

  <span class="hljs-keyword">get</span> userName() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.authService.userName;
  }

  login() {
    <span class="hljs-keyword">this</span>.authService.login();
  }

  logout() {
    <span class="hljs-keyword">this</span>.authService.logout();
  }

}
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Open the file <code>home.component.html</code>. Display the current user name and offer buttons for login or logout.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"userName"</span>&gt;</span>Willkommen, {{userName}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"!userName"</span>&gt;</span>Willkommen!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"login()"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"logout()"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Register the <code>AuthGuard</code> in the route configuration in <code>flight-booking.routes.ts</code> to protect one of the established routes.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> FLIGHT_BOOKING_ROUTES: Routes = [
    {
        path: <span class="hljs-string">'...'</span>,
        component: [...],
        canActivate:[AuthGuard],
        [...]
    }
    [...]
];
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Test your solution.</p>
</li>
</ol>
<h2 id="bonus-login">Bonus: Login **</h2>
<p>Extend the <code>AuthService</code> so that it verifies with hard-coded data whether a particular username/password combination exists. Use this service in the <code>login</code> method of the <code>AuthService</code>. Expand the login mask so that the user can enter username and password here. If you use <code>ngModel</code>, make sure that the <code>FormsModule</code> is imported into the <code>AppModule</code>.</p>
<h2 id="candeactivateguard">CanDeactivateGuard</h2>
<p>In this exercise, you will develop a <code>CanDeactivate</code>-Guard to warn the user before leaving a route.</p>
<ol>
<li>
<p>Create a <code>deactivation</code> folder in the <code>shared</code> folder.</p>
</li>
<li>
<p>Create a file <code>can-deactivate.guard</code> in the new folder <code>deactivation</code>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> CanDeactivateComponent {
  canDeactivate(): Observable&lt;<span class="hljs-built_in">boolean</span>&gt;;
}

@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> CanDeactivateGuard <span class="hljs-keyword">implements</span> CanDeactivate&lt;CanDeactivateComponent&gt; {

  canDeactivate(
    component: CanDeactivateComponent,
    currentRoute: ActivatedRouteSnapshot,
    currentState: RouterStateSnapshot,
    nextState?: RouterStateSnapshot): Observable&lt;<span class="hljs-built_in">boolean</span>&gt; {

    <span class="hljs-keyword">return</span> component.canDeactivate();

  }

}
</div></code></pre>
<p>The interface <code>CanDeactivateComponent</code> is used here as an abstraction for the components to be used with the Guard.</p>
</li>
<li>
<p>Open the file <code>flight-edit.component.ts</code> and implement there the interface <code>CanDeactivateComponent</code> so that on exit one flag is set and on the other hand an <code>Observable&lt;boolean&gt;</code> is returned. The flag causes a warning message to be displayed. Once the user has announced that we really want to leave the route, we want to send <code>true</code> or <code>false</code> to the router via the observable. After that it has to be closed. In addition, the flag should be reset afterwards.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> FlightEditComponent <span class="hljs-keyword">implements</span> OnInit, CanDeactivateComponent {
  
  [...]

  sender: Observer&lt;<span class="hljs-built_in">boolean</span>&gt;;
  showWarning = <span class="hljs-literal">false</span>;

  decide(decision: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">this</span>.showWarning = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.sender.next(decision);
    <span class="hljs-keyword">this</span>.sender.complete();
  }

  canDeactivate(): Observable&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">return</span> Observable.create((sender: Observer&lt;<span class="hljs-built_in">boolean</span>&gt;) =&gt; {
      <span class="hljs-keyword">this</span>.sender = sender;
      <span class="hljs-keyword">this</span>.showWarning = <span class="hljs-literal">true</span>;
    });

  }

  [...]
}
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Extend the file <code>flight-edit.component.html</code> with the previously mentioned warning. It should present two possible possibilities (<code>yes</code> and <code>no</code>) to the user.</p>
</li>
<li>
<p>Register the Guard in the <code>shared.module.ts</code> file.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>@NgModule({
  [...]
  providers: [
    [...],
    CanDeactivateGuard
  ],
  [...]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> SharedModule { }
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Also register the Guard in the file <code>flight-booking.routes.ts</code>:</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>[...]
{
    path: <span class="hljs-string">'flight-edit/:id'</span>,
    component: FlightEditComponent,
    canDeactivate: [CanDeactivateGuard]
},
[...]
</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Test your solution.</p>
</li>
</ol>
<h2 id="httpinterceptor">HttpInterceptor</h2>
<p>In this exercise, you'll write an <code>HttpInterceptor</code> that appends a header with authentication information to each request directed to a particular url. It will also redirect the user to the <code>home</code> route in the event of an authentication error (HTTP code 401 or 403).</p>
<p>For the time being, the authentication information will only contain dummy data. However, the Authentication exercise will then switch to meaningful information.</p>
<ol>
<li>
<p>Create a file <code>auth.interceptor.ts</code> in the <code>shared/auth</code> folder of your application (<code>apps/flight-app</code>).</p>
</li>
<li>
<p>Create an <code>AuthInterceptor</code> service in this file that implements the <code>HttpInterceptor</code> interface. It should extend all requests as mentioned above in order to send the user to the <code>home</code> route in case of an authentication error.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> { Injectable } from <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpErrorResponse } from <span class="hljs-string">'@angular/common/http'</span>;
<span class="hljs-keyword">import</span> {Observable} from <span class="hljs-string">'rxjs/Observable'</span>;

<span class="hljs-keyword">import</span> { catchError } from <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { _throw } from <span class="hljs-string">'rxjs/observable/throw'</span>;

<span class="hljs-keyword">import</span> { Router } from <span class="hljs-string">'@angular/router'</span>;


@Injectable()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthInterceptor <span class="hljs-keyword">implements</span> HttpInterceptor {
        
	<span class="hljs-keyword">constructor</span>(private router: Router) {
	}

	<span class="hljs-keyword">public</span> intercept(req: HttpRequest&lt;<span class="hljs-built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="hljs-built_in">any</span>&gt;&gt; {
			
		<span class="hljs-comment">// Important: Don't send out sensitive </span>
		<span class="hljs-comment">//            security header to everyone!</span>
		<span class="hljs-keyword">if</span> (req.url.startsWith(<span class="hljs-string">'http://www.angular.at'</span>)) {
			<span class="hljs-keyword">let</span> headers = req.headers.set(<span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'Basic Just-for-Demonstration'</span>);
			<span class="hljs-comment">// We will add a meaningful header later during the auth exercise!</span>
			req = req.clone({ headers });
		}

		<span class="hljs-keyword">return</span> next
			.handle(req)
			.pipe(
				catchError(error =&gt; <span class="hljs-keyword">this</span>.handleError(error))
			);

	}

	<span class="hljs-keyword">private</span> handleError(event: HttpErrorResponse) {
		<span class="hljs-keyword">if</span> (event.status == <span class="hljs-number">401</span> || event.status == <span class="hljs-number">403</span>) {
			<span class="hljs-keyword">this</span>.router.navigate([<span class="hljs-string">'/home'</span>, {needsLogin: <span class="hljs-literal">true</span>}]);
		}
		<span class="hljs-keyword">return</span> _throw(event);
	}
}

</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Register this interceptor with the <code>SharedModule</code> in the <code>forRoot</code> method. Set up a multi-provider with the token <code>HTTP_INTERCEPTORS</code>.</p>
 <details>
 <summary>Show code</summary>
 <p>
<pre class="hljs"><code><div>@NgModule([...])
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> SharedModule {
    <span class="hljs-keyword">static</span> forRoot(): ModuleWithProviders {
        <span class="hljs-keyword">return</span> {
            [...]
            {
                provide: HTTP_INTERCEPTORS,
                useClass: AuthInterceptor,
                multi: <span class="hljs-literal">true</span>
            }
        }
    }
}

</div></code></pre>
 </p>
 </details>
</li>
<li>
<p>Test your interceptor by searching for flights and checking the <code>urgent</code> checkbox. As in the real world, the search fails when it is urgent ;-). This should cause the Interceptor to redirect you to the <code>home</code> route.</p>
</li>
<li>
<p>Open the <code>Network</code> tab in the Dev tools (F12).</p>
</li>
<li>
<p>Search again for flights, but with the checkbox deactivated.</p>
</li>
<li>
<p>You should now see in the tab <code>Network</code> that the defined authorization header with the dummy data is sent.</p>
<p><img src="https://i.imgur.com/JFRVNaJ.png" alt="Authorization header"></p>
</li>
<li>
<p>Since the <code>HttpInterceptor</code> is active for every request, you should be able to observe this behavior when fetching all airports too.</p>
</li>
</ol>

    </body>
    </html>